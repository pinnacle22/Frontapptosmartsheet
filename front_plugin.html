
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search for Numbers</title>
    <script src="https://cdn.frontapp.com/plugin-sdk.js"></script>
</head>
<body>
    <h1>Search for 11-Digit Numbers</h1>
    <div id="output"></div>

    <script>
        const smartsheetApiKey = '4wXxOQXzJvd1BZFUWLPlhzCbJzR0vKGnz78be';
        const sheetId = '6173713812639620';

        async function searchSmartsheet(bolNumber) {
            const response = await fetch(`https://api.smartsheet.com/2.0/sheets/${sheetId}`, {
                headers: {
                    'Authorization': `Bearer ${smartsheetApiKey}`,
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();
            const rows = data.rows;
            const columns = data.columns;

            // Get column IDs by title
            const columnMap = columns.reduce((map, col) => {
                map[col.title] = col.id;
                return map;
            }, {});

            const targetColumns = [
                'CaboLink', 'Origin City', 'Origin State', 'Destination City', 'Destination State',
                'Pickup Date', 'Pickup Time', 'Delivery Date', 'Delivery Time', 'Cost (or carrier cost)',
                'Customer Charge (Revenue)'
            ];

            let foundRow = null;

            for (const row of rows) {
                for (const cell of row.cells) {
                    if (cell.displayValue && cell.displayValue.includes(bolNumber)) {
                        foundRow = row;
                        break;
                    }
                }
                if (foundRow) break;
            }

            if (foundRow) {
                let result = {};
                for (const col of targetColumns) {
                    const colId = columnMap[col];
                    if (colId) {
                        const cell = foundRow.cells.find(c => c.columnId === colId);
                        result[col] = cell ? cell.displayValue || cell.value : 'N/A';
                    } else {
                        result[col] = 'N/A';
                    }
                }
                document.getElementById('output').innerText = JSON.stringify(result, null, 2);
            } else {
                document.getElementById('output').innerText = 'No matches found in Smartsheet';
            }
        }

        Front.contextUpdates.subscribe(context => {
            if (context.type === 'message') {
                const regex = /60\d{9}/g;
                const matches = context.data.text.match(regex);
                if (matches) {
                    const bolNumber = matches[0];
                    searchSmartsheet(bolNumber);
                } else {
                    document.getElementById('output').innerText = 'No matches found in email';
                }
            }
        });
    </script>
</body>
</html>
